---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Analyse mass evolution

## Prep libraries

```{r}
# prepare parameter combinations
library(data.table)
library(ggplot2)
```

## Clear data

```{r eval=FALSE}
system("rm data/*.csv")
```

## Get new data

```{r}
password <- readLines("data/password")
# get new data
s <- ssh::ssh_connect("peregrine.hpc.rug.nl", passwd = password)

ssh::scp_download(s,
                  files = "noisewalker/data/",
                  to = ".")

ssh::ssh_disconnect(s)
```

## Read mass summary data

```{r}
# read data of mass summary
mass_files <- list.files("data/", pattern = "(summary)", full.names = T)
params <- fread("data/lookup.csv")
```

## Body mass evolution

```{r}
# read mass data
mass_data <- lapply(mass_files, fread)

# get quantiles
mass_data <- lapply(mass_data, function (df) {
  df[, mass := lapply(stringi::stri_split(mass, fixed = ";"), as.numeric)]
})

# summarise
mass_summary <- lapply(mass_data, function(df) {
  mass_table <- Map(function(m, g) {
    dt <- as.data.table(table(round(m, 1)))
    dt$gen <- g
    return(dt)
    }, df$mass, df$gen
  )
  return(rbindlist(mass_table))
})
```

```{r}
# add params
mass_summary <- Map(function(df, f, ft, repl) {
  df[, `:=` (f = f, ft = ft, r = repl)]
}, mass_summary, params$frequency, params$fTransfer, params$rep)
```


```{r}
dm <- rbindlist(mass_summary)
dm <- split(dm, by = c("f", "ft"))

# plot
plots <- lapply(dm, function(d){
  ggplot(d)+
    geom_vline(xintercept = 1000, lwd = 0.2)+
    geom_tile(aes(gen, as.numeric(V1), fill = N),
              show.legend = F)+
    scale_fill_viridis_c(option = "D")+
    facet_grid(~r)+
    coord_cartesian(ylim = c(0, 10))+
    labs(title = sprintf('ancestral f = %s, new f = %s', unique(d$f), 
                         unique(d$ft)),
         y = "mass")
})

wrap_plots(plots)

ggsave("figures/fig_mass_evol_02.png")
```
